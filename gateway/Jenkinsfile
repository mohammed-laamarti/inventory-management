pipeline {
    agent any

    environment {
        // Configuration du service
        SERVICE_NAME = 'gateway-service'
        SERVICE_DIR = 'gateway'

        // Azure Container Registry
        ACR_NAME = 'mohammed'
        ACR_URL = "${ACR_NAME}.azurecr.io"
        IMAGE_NAME = "${ACR_URL}/gateway"

        // Azure Kubernetes
        AKS_CLUSTER = 'aks'
        AKS_RESOURCE_GROUP = 'aks-Cloud'
        K8S_NAMESPACE = 'inventory'

        // Credentials IDs (√† cr√©er dans Jenkins)
        AZURE_CREDENTIALS_ID = 'azure-jenkins-sp'

        // Version de l'image
        IMAGE_TAG = "${env.GIT_COMMIT?.take(7) ?: BUILD_NUMBER}"

        // Maven
        MAVEN_OPTS = '-Dmaven.repo.local=.m2/repository'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
    }

    stages {
        stage('üîç Checkout Code') {
            steps {
                echo "=== Checkout du code pour ${SERVICE_NAME} ==="
                checkout scm

                script {
                    // V√©rifier si des changements dans gateway/
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1 2>/dev/null || echo "gateway/"',
                        returnStdout: true
                    ).trim()

                    if (!changes.contains('gateway/') && !changes.contains('Jenkinsfile')) {
                        echo "‚ö†Ô∏è  Aucun changement dans gateway/, skip du build"
                        currentBuild.result = 'NOT_BUILT'
                        error('Aucun changement d√©tect√© dans gateway/')
                    }

                    echo "‚úÖ Changements d√©tect√©s dans gateway/"
                }
            }
        }

        stage('‚òï Setup Java 17') {
            steps {
                echo "=== Configuration de Java 17 ==="

                script {
                    sh 'java -version'
                    sh 'mvn -version'
                }
            }
        }

        stage('üì¶ Build with Maven') {
            steps {
                echo "=== Build Maven du Gateway Service ==="
                dir(SERVICE_DIR) {
                    sh """
                        mvn clean package -DskipTests ${MAVEN_OPTS}
                    """
                }
            }
            post {
                success {
                    echo "‚úÖ Build Maven r√©ussi"
                }
                failure {
                    echo "‚ùå Build Maven √©chou√©"
                }
            }
        }

        stage('üîê Login to Azure') {
            steps {
                echo "=== Connexion √† Azure ==="
                withCredentials([azureServicePrincipal(
                    credentialsId: AZURE_CREDENTIALS_ID,
                    subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                    clientIdVariable: 'AZURE_CLIENT_ID',
                    clientSecretVariable: 'AZURE_CLIENT_SECRET',
                    tenantIdVariable: 'AZURE_TENANT_ID'
                )]) {
                    sh """
                        az login --service-principal \
                            -u \$AZURE_CLIENT_ID \
                            -p \$AZURE_CLIENT_SECRET \
                            --tenant \$AZURE_TENANT_ID

                        az account set --subscription \$AZURE_SUBSCRIPTION_ID
                    """
                }
            }
        }

        stage('üê≥ Login to Azure Container Registry') {
            steps {
                echo "=== Connexion √† Azure Container Registry ==="
                sh "az acr login --name ${ACR_NAME}"
            }
        }

        stage('üèóÔ∏è  Build Docker Image') {
            steps {
                echo "=== Build de l'image Docker ==="
                dir(SERVICE_DIR) {
                    script {
                        sh """
                            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                        """
                    }
                }
            }
            post {
                success {
                    echo "‚úÖ Image Docker construite: ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('üîí Scan Docker Image with Trivy') {
            steps {
                echo "=== Scan de s√©curit√© avec Trivy ==="
                script {
                    sh """
                        trivy image \
                            --format sarif \
                            --output trivy-results.sarif \
                            --severity HIGH,CRITICAL \
                            ${IMAGE_NAME}:${IMAGE_TAG} || true
                    """

                    sh """
                        trivy image \
                            --severity HIGH,CRITICAL \
                            ${IMAGE_NAME}:${IMAGE_TAG} || true
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-results.sarif', allowEmptyArchive: true
                }
            }
        }

        stage('üì§ Push Docker Image') {
            steps {
                echo "=== Push de l'image vers ACR ==="
                sh """
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    docker push ${IMAGE_NAME}:latest
                """
            }
            post {
                success {
                    echo "‚úÖ Image push√©e: ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('‚ò∏Ô∏è  Set AKS Context') {
            steps {
                echo "=== Configuration du contexte AKS ==="
                withCredentials([azureServicePrincipal(
                    credentialsId: AZURE_CREDENTIALS_ID,
                    subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                    clientIdVariable: 'AZURE_CLIENT_ID',
                    clientSecretVariable: 'AZURE_CLIENT_SECRET',
                    tenantIdVariable: 'AZURE_TENANT_ID'
                )]) {
                    sh """
                        az aks get-credentials \
                            --resource-group ${AKS_RESOURCE_GROUP} \
                            --name ${AKS_CLUSTER} \
                            --overwrite-existing
                    """
                }

                sh 'kubectl cluster-info'
                sh "kubectl get nodes"
            }
        }

        stage('üöÄ Deploy to AKS') {
            steps {
                echo "=== D√©ploiement vers AKS ==="
                sh """
                    kubectl set image deployment/${SERVICE_NAME} \
                        ${SERVICE_NAME}=${IMAGE_NAME}:${IMAGE_TAG} \
                        -n ${K8S_NAMESPACE}

                    echo "Attente du rollout..."
                    kubectl rollout status deployment/${SERVICE_NAME} \
                        -n ${K8S_NAMESPACE} \
                        --timeout=5m
                """
            }
            post {
                success {
                    echo "‚úÖ D√©ploiement r√©ussi sur AKS"

                    // Afficher l'URL du LoadBalancer
                    script {
                        sh """
                            echo "\\nüåê R√©cup√©ration de l'IP externe du Gateway..."
                            kubectl get service ${SERVICE_NAME} -n ${K8S_NAMESPACE}
                        """
                    }
                }
                failure {
                    echo "‚ùå D√©ploiement √©chou√©, rollback en cours..."
                    sh """
                        kubectl rollout undo deployment/${SERVICE_NAME} \
                            -n ${K8S_NAMESPACE} || true
                    """
                }
            }
        }

        stage('‚úÖ Verify Deployment') {
            steps {
                echo "=== V√©rification du d√©ploiement ==="
                sh """
                    echo "Status des pods:"
                    kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}

                    echo "\\nStatus du deployment:"
                    kubectl get deployment ${SERVICE_NAME} -n ${K8S_NAMESPACE}

                    echo "\\nStatus du service (LoadBalancer):"
                    kubectl get service ${SERVICE_NAME} -n ${K8S_NAMESPACE}

                    echo "\\n‚è≥ Attente de l'IP externe (peut prendre 1-2 minutes)..."
                    kubectl get service ${SERVICE_NAME} -n ${K8S_NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "En attente..."
                """
            }
        }
    }

    post {
        success {
            echo """
            ========================================
            ‚úÖ Pipeline Gateway Service r√©ussi !
            ========================================
            Image: ${IMAGE_NAME}:${IMAGE_TAG}
            Namespace: ${K8S_NAMESPACE}
            Build: #${BUILD_NUMBER}

            üåê Point d'entr√©e principal de l'application
            Type: LoadBalancer (IP externe)
            Port: 8222

            R√©cup√©rez l'IP externe avec:
            kubectl get svc gateway-service -n inventory
            ========================================
            """
        }

        failure {
            echo """
            ========================================
            ‚ùå Pipeline Gateway Service √©chou√© !
            ========================================
            Build: #${BUILD_NUMBER}
            Consultez les logs pour plus de d√©tails
            ========================================
            """
        }

        always {
            echo "=== Nettoyage ==="

            sh """
                docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true
                docker rmi ${IMAGE_NAME}:latest || true
            """

            sh 'az logout || true'
        }
    }
}
