pipeline {
    agent any

    environment {
        // Configuration du service
        SERVICE_NAME = 'supplier-service'
        SERVICE_DIR = 'supplier'

        // Azure Container Registry
        ACR_NAME = 'mohammed'
        ACR_URL = "${ACR_NAME}.azurecr.io"
        IMAGE_NAME = "${ACR_URL}/${SERVICE_NAME}"

        // Azure Kubernetes
        AKS_CLUSTER = 'aks'
        AKS_RESOURCE_GROUP = 'aks-Cloud'
        K8S_NAMESPACE = 'inventory'

        // Credentials IDs (√† cr√©er dans Jenkins)
        AZURE_CREDENTIALS_ID = 'azure-jenkins-sp'

        // Version de l'image
        IMAGE_TAG = "${env.GIT_COMMIT?.take(7) ?: BUILD_NUMBER}"

        // Maven
        MAVEN_OPTS = '-Dmaven.repo.local=.m2/repository'
    }

    // D√©clencher seulement si changements dans supplier/
    options {
        // Garder seulement les 10 derniers builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // Timeout apr√®s 30 minutes
        timeout(time: 30, unit: 'MINUTES')
        // D√©sactiver concurrent builds
        disableConcurrentBuilds()
    }

    stages {
        stage('üîç Checkout Code') {
            steps {
                echo "=== Checkout du code pour ${SERVICE_NAME} ==="
                checkout scm

                script {
                    // V√©rifier si des changements dans supplier/
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1 2>/dev/null || echo "supplier/"',
                        returnStdout: true
                    ).trim()

                    if (!changes.contains('supplier/') && !changes.contains('Jenkinsfile')) {
                        echo "‚ö†Ô∏è  Aucun changement dans supplier/, skip du build"
                        currentBuild.result = 'NOT_BUILT'
                        error('Aucun changement d√©tect√© dans supplier/')
                    }

                    echo "‚úÖ Changements d√©tect√©s dans supplier/"
                }
            }
        }

        stage('‚òï Setup Java 17') {
            steps {
                echo "=== Configuration de Java 17 ==="
                script {
                    // Java devrait √™tre d√©j√† install√© sur l'agent Jenkins
                    sh 'java -version'
                    sh 'mvn -version'
                }
            }
        }

        stage('üì¶ Build with Maven') {
            steps {
                echo "=== Build Maven du Supplier Service ==="
                dir(SERVICE_DIR) {
                    sh """
                        mvn clean package -DskipTests ${MAVEN_OPTS}
                    """
                }
            }
            post {
                success {
                    echo "‚úÖ Build Maven r√©ussi"
                }
                failure {
                    echo "‚ùå Build Maven √©chou√©"
                }
            }
        }

        stage('üîê Login to Azure') {
            steps {
                echo "=== Connexion √† Azure ==="
                withCredentials([azureServicePrincipal(
                    credentialsId: AZURE_CREDENTIALS_ID,
                    subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                    clientIdVariable: 'AZURE_CLIENT_ID',
                    clientSecretVariable: 'AZURE_CLIENT_SECRET',
                    tenantIdVariable: 'AZURE_TENANT_ID'
                )]) {
                    sh """
                        az login --service-principal \
                            -u \$AZURE_CLIENT_ID \
                            -p \$AZURE_CLIENT_SECRET \
                            --tenant \$AZURE_TENANT_ID

                        az account set --subscription \$AZURE_SUBSCRIPTION_ID
                    """
                }
            }
        }

        stage('üê≥ Login to Azure Container Registry') {
            steps {
                echo "=== Connexion √† Azure Container Registry ==="
                sh "az acr login --name ${ACR_NAME}"
            }
        }

        stage('üèóÔ∏è  Build Docker Image') {
            steps {
                echo "=== Build de l'image Docker ==="
                dir(SERVICE_DIR) {
                    script {
                        sh """
                            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                        """
                    }
                }
            }
            post {
                success {
                    echo "‚úÖ Image Docker construite: ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('üîí Scan Docker Image with Trivy') {
            steps {
                echo "=== Scan de s√©curit√© avec Trivy ==="
                script {
                    // Scanner l'image avec Trivy
                    sh """
                        trivy image \
                            --format sarif \
                            --output trivy-results.sarif \
                            --severity HIGH,CRITICAL \
                            ${IMAGE_NAME}:${IMAGE_TAG} || true
                    """

                    // Scanner en mode table pour les logs
                    sh """
                        trivy image \
                            --severity HIGH,CRITICAL \
                            ${IMAGE_NAME}:${IMAGE_TAG} || true
                    """
                }
            }
            post {
                always {
                    // Archiver les r√©sultats
                    archiveArtifacts artifacts: 'trivy-results.sarif', allowEmptyArchive: true
                }
            }
        }

        stage('üì§ Push Docker Image') {
            steps {
                echo "=== Push de l'image vers ACR ==="
                sh """
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    docker push ${IMAGE_NAME}:latest
                """
            }
            post {
                success {
                    echo "‚úÖ Image push√©e: ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('‚ò∏Ô∏è  Set AKS Context') {
            steps {
                echo "=== Configuration du contexte AKS ==="
                withCredentials([azureServicePrincipal(
                    credentialsId: AZURE_CREDENTIALS_ID,
                    subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                    clientIdVariable: 'AZURE_CLIENT_ID',
                    clientSecretVariable: 'AZURE_CLIENT_SECRET',
                    tenantIdVariable: 'AZURE_TENANT_ID'
                )]) {
                    sh """
                        az aks get-credentials \
                            --resource-group ${AKS_RESOURCE_GROUP} \
                            --name ${AKS_CLUSTER} \
                            --overwrite-existing
                    """
                }

                // V√©rifier la connexion
                sh 'kubectl cluster-info'
                sh "kubectl get nodes"
            }
        }

        stage('üöÄ Deploy to AKS') {
            steps {
                echo "=== D√©ploiement vers AKS ==="
                sh """
                    kubectl set image deployment/${SERVICE_NAME} \
                        ${SERVICE_NAME}=${IMAGE_NAME}:${IMAGE_TAG} \
                        -n ${K8S_NAMESPACE}

                    echo "Attente du rollout..."
                    kubectl rollout status deployment/${SERVICE_NAME} \
                        -n ${K8S_NAMESPACE} \
                        --timeout=5m
                """
            }
            post {
                success {
                    echo "‚úÖ D√©ploiement r√©ussi sur AKS"
                }
                failure {
                    echo "‚ùå D√©ploiement √©chou√©, rollback en cours..."
                    sh """
                        kubectl rollout undo deployment/${SERVICE_NAME} \
                            -n ${K8S_NAMESPACE} || true
                    """
                }
            }
        }

        stage('‚úÖ Verify Deployment') {
            steps {
                echo "=== V√©rification du d√©ploiement ==="
                sh """
                    echo "Status des pods:"
                    kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}

                    echo "\\nStatus du deployment:"
                    kubectl get deployment ${SERVICE_NAME} -n ${K8S_NAMESPACE}

                    echo "\\nStatus du service:"
                    kubectl get service ${SERVICE_NAME} -n ${K8S_NAMESPACE} || echo "Pas de service trouv√©"
                """
            }
        }
    }

    post {
        success {
            echo """
            ========================================
            ‚úÖ Pipeline Supplier Service r√©ussi !
            ========================================
            Image: ${IMAGE_NAME}:${IMAGE_TAG}
            Namespace: ${K8S_NAMESPACE}
            Build: #${BUILD_NUMBER}
            ========================================
            """

            // Notification (optionnel)
            // slackSend color: 'good', message: "‚úÖ Supplier Service d√©ploy√© avec succ√®s"
        }

        failure {
            echo """
            ========================================
            ‚ùå Pipeline Supplier Service √©chou√© !
            ========================================
            Build: #${BUILD_NUMBER}
            Consultez les logs pour plus de d√©tails
            ========================================
            """

            // Notification (optionnel)
            // slackSend color: 'danger', message: "‚ùå Supplier Service d√©ploiement √©chou√©"
        }

        always {
            echo "=== Nettoyage ==="

            // Nettoyer les images Docker locales pour √©conomiser l'espace
            sh """
                docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true
                docker rmi ${IMAGE_NAME}:latest || true
            """

            // Logout Azure
            sh 'az logout || true'

            // Nettoyer le workspace (optionnel)
            // cleanWs()
        }
    }
}
