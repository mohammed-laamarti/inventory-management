pipeline {
    agent {
        label 'maven-docker'  // ‚Üê Utilise l'agent avec tous les outils
    }

    environment {
        // Configuration du service
        SERVICE_NAME = 'product-service'
        SERVICE_DIR = 'product'

        // Azure Container Registry
        ACR_NAME = 'mohammed'
        ACR_URL = "${ACR_NAME}.azurecr.io"
        IMAGE_NAME = "${ACR_URL}/${SERVICE_NAME}"

        // Azure Kubernetes
        AKS_CLUSTER = 'aks'
        AKS_RESOURCE_GROUP = 'aks-Cloud'
        K8S_NAMESPACE = 'inventory'

        // Credentials IDs
        AZURE_CREDENTIALS_ID = 'azure-jenkins'

        // Version de l'image
        IMAGE_TAG = "${env.GIT_COMMIT?.take(7) ?: BUILD_NUMBER}"

        // Maven
        MAVEN_OPTS = '-Dmaven.repo.local=.m2/repository'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
    }

    stages {
        stage('üîç Checkout Code') {
            steps {
                echo "=== Checkout du code pour ${SERVICE_NAME} ==="
                checkout scm
            }
        }

        stage('‚òï Setup Java 17') {
            steps {
                container('maven') {
                    echo "=== Configuration de Java 17 ==="
                    sh 'java -version'
                    sh 'mvn -version'
                }
            }
        }

        stage('üì¶ Build with Maven') {
            steps {
                container('maven') {
                    echo "=== Build Maven du Product Service ==="
                    dir(SERVICE_DIR) {
                        sh "mvn clean package -DskipTests ${MAVEN_OPTS}"
                    }
                }
            }
        }

        stage('üîê Login to Azure') {
            steps {
                container('azure-cli') {
                    echo "=== Connexion √† Azure ==="
                    withCredentials([azureServicePrincipal(
                        credentialsId: AZURE_CREDENTIALS_ID,
                        subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                        clientIdVariable: 'AZURE_CLIENT_ID',
                        clientSecretVariable: 'AZURE_CLIENT_SECRET',
                        tenantIdVariable: 'AZURE_TENANT_ID'
                    )]) {
                        sh """
                            az login --service-principal \
                                -u \$AZURE_CLIENT_ID \
                                -p \$AZURE_CLIENT_SECRET \
                                --tenant \$AZURE_TENANT_ID
                            az account set --subscription \$AZURE_SUBSCRIPTION_ID
                        """
                    }
                }
            }
        }

        stage('üê≥ Login to Azure Container Registry') {
            steps {
                container('azure-cli') {
                    echo "=== Connexion √† Azure Container Registry ==="
                    sh "az acr login --name ${ACR_NAME}"
                }
            }
        }

        stage('üèóÔ∏è  Build Docker Image') {
            steps {
                container('docker') {
                    echo "=== Build de l'image Docker ==="
                    dir(SERVICE_DIR) {
                        sh """
                            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }

        stage('üîí Scan Docker Image with Trivy') {
            steps {
                container('trivy') {
                    echo "=== Scan de s√©curit√© avec Trivy ==="
                    sh """
                        trivy image \
                            --format sarif \
                            --output trivy-results.sarif \
                            --severity HIGH,CRITICAL \
                            ${IMAGE_NAME}:${IMAGE_TAG} || true
                    """
                }
            }
        }

        stage('üì§ Push Docker Image') {
            steps {
                container('docker') {
                    echo "=== Push de l'image vers ACR ==="
                    sh """
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                        docker push ${IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('‚ò∏Ô∏è  Set AKS Context') {
            steps {
                container('azure-cli') {
                    echo "=== Configuration du contexte AKS ==="
                    withCredentials([azureServicePrincipal(
                        credentialsId: AZURE_CREDENTIALS_ID,
                        subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                        clientIdVariable: 'AZURE_CLIENT_ID',
                        clientSecretVariable: 'AZURE_CLIENT_SECRET',
                        tenantIdVariable: 'AZURE_TENANT_ID'
                    )]) {
                        sh """
                            az aks get-credentials \
                                --resource-group ${AKS_RESOURCE_GROUP} \
                                --name ${AKS_CLUSTER} \
                                --overwrite-existing
                        """
                    }
                }
            }
        }

        stage('üöÄ Deploy to AKS') {
            steps {
                container('kubectl') {
                    echo "=== D√©ploiement vers AKS ==="
                    sh """
                        kubectl set image deployment/${SERVICE_NAME} \
                            ${SERVICE_NAME}=${IMAGE_NAME}:${IMAGE_TAG} \
                            -n ${K8S_NAMESPACE}
                        kubectl rollout status deployment/${SERVICE_NAME} \
                            -n ${K8S_NAMESPACE} \
                            --timeout=10m
                    """
                }
            }
            post {
                failure {
                    container('kubectl') {
                        sh """
                            kubectl rollout undo deployment/${SERVICE_NAME} \
                                -n ${K8S_NAMESPACE} || true
                        """
                    }
                }
            }
        }

        stage('‚úÖ Verify Deployment') {
            steps {
                container('kubectl') {
                    echo "=== V√©rification du d√©ploiement ==="
                    sh """
                        kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                        kubectl get deployment ${SERVICE_NAME} -n ${K8S_NAMESPACE}
                        kubectl get service ${SERVICE_NAME} -n ${K8S_NAMESPACE} || true
                    """
                }
            }
        }
    }

    post {
        always {
            container('docker') {
                sh """
                    docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true
                    docker rmi ${IMAGE_NAME}:latest || true
                """
            }
            container('azure-cli') {
                sh 'az logout || true'
            }
        }
    }
}